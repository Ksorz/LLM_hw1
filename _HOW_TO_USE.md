# –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ML-—Å–µ—Ä–≤–∏—Å

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–≥–æ —Å—Ç–µ–∫–∞ (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è) üèóÔ∏è_0

–°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± —É–≤–∏–¥–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç "–£—Å–ª–æ–∂–Ω–µ–Ω–∏—è 0" ‚Äî –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å—ë —á–µ—Ä–µ–∑ Docker Compose.

```bash
make up-full
```

–≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –ø–æ–¥–Ω–∏–º–µ—Ç 5 –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:
1. **Frontend (Streamlit)**: http://localhost:8501 ‚Äî –ß–∞—Ç —Å –º–æ–¥–µ–ª—å—é.
2. **API (FastAPI)**: http://localhost:8000/docs ‚Äî Swagger UI.
3. **Grafana**: http://localhost:3000 ‚Äî –î–∞—à–±–æ—Ä–¥—ã (login: `admin`/`admin`).
4. **Prometheus**: http://localhost:9090 ‚Äî –ú–µ—Ç—Ä–∏–∫–∏.
5. **PostgreSQL**: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (–ø–æ—Ä—Ç 5432).

### 2. –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ API (–õ–æ–∫–∞–ª—å–Ω–æ)

–ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å API –±–µ–∑ Docker (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏):

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–æ–≤—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
pip install sqlalchemy psycopg2-binary prometheus-fastapi-instrumentator

# –ó–∞–ø—É—Å–∫ (—Ç—Ä–µ–±—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–π Postgres –∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ DATABASE_URL)
make serve
```

---

## –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã

### üñ•Ô∏è Frontend (–ß–∞—Ç)
–û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:8501.
–ó–¥–µ—Å—å –º–æ–∂–Ω–æ –æ–±—â–∞—Ç—å—Å—è —Å –º–æ–¥–µ–ª—å—é –≤ —Ä–µ–∂–∏–º–µ –¥–∏–∞–ª–æ–≥–∞. –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —Ä–∞–º–∫–∞—Ö —Å–µ—Å—Å–∏–∏ –±—Ä–∞—É–∑–µ—Ä–∞.

### üîå API Endpoints
- **POST /forward**: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ (–ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ –ë–î).
- **POST /forward_batch**: –ë–∞—Ç—á–µ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è.
- **GET /metadata**: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–æ–¥–µ–ª–∏.
- **GET /metrics**: –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è Prometheus (üÜï).

### üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- **Grafana** (http://localhost:3000): –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫. –í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å Prometheus –∫–∞–∫ Data Source (`http://prometheus:9090`) –∏ —Å–æ–∑–¥–∞—Ç—å –¥–∞—à–±–æ—Ä–¥.
- **Prometheus** (http://localhost:9090): –°—ã—Ä—ã–µ –º–µ—Ç—Ä–∏–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–ø—Ä–æ—Å–∏—Ç—å `http_requests_total`.

### üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
–í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∫ API –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü—É `request_logs` –≤ PostgreSQL.
–ü–æ–ª—è: `timestamp`, `input_text`, `output_text`, `processing_time_ms`, `model_name`.

---

## End-to-End: –û–±—É—á–µ–Ω–∏–µ ‚Üí API

### –®–∞–≥ 1: –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)

```bash
make train-baseline
```

### –®–∞–≥ 2: –ó–∞–ø—É—Å–∫ —Å –æ–±—É—á–µ–Ω–Ω–æ–π –º–æ–¥–µ–ª—å—é

–ï—Å–ª–∏ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Docker Compose, –≤–∞–º –Ω—É–∂–Ω–æ –ø—Ä–æ–∫–∏–Ω—É—Ç—å –ø—É—Ç—å –∫ checkpoint –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ `.env` —Ñ–∞–π–ª, –ª–∏–±–æ –ø—Ä–æ—Å—Ç–æ —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å volume.
–î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã, –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ:

```bash
make serve-trained CHECKPOINT=/app/output_dir/gpt2-1b-russian/checkpoint-1000
```

---

## Docker –∫–æ–º–∞–Ω–¥—ã

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å—ë (—Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º)
make up-full

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ API –∏ –ë–î
docker-compose up -d api db

# –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏ –∫–æ–¥)
make docker-build

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å—ë
docker-compose down

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ API
docker-compose logs -f api
```

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:

```env
CUDA_VISIBLE_DEVICES=0
DATABASE_URL=postgresql://postgres:postgres@db:5432/llm_service
GRAFANA_PASSWORD=admin
```

---

## Troubleshooting

### –û—à–∏–±–∫–∞: "Connection refused" –∫ –ë–î
–ï—Å–ª–∏ API –ø–∞–¥–∞–µ—Ç —Å –æ—à–∏–±–∫–æ–π –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥. Docker Compose –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ `healthcheck`, –Ω–æ –∏–Ω–æ–≥–¥–∞ –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ Postgres –∑–∞–Ω–∏–º–∞–µ—Ç –≤—Ä–µ–º—è. –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä `api` –¥–æ–ª–∂–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è.

### –û—à–∏–±–∫–∞: "CUDA out of memory"
–£–º–µ–Ω—å—à–∏—Ç–µ —Ä–∞–∑–º–µ—Ä –±–∞—Ç—á–∞ –∏–ª–∏ `max_new_tokens` –≤ –∑–∞–ø—Ä–æ—Å–µ. –ò–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ API –Ω–∞ CPU:
`python serve.py --device cpu`

### –ö–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ë–î –≤—Ä—É—á–Ω—É—é?
```bash
docker exec -it llm_db psql -U postgres -d llm_service
# \dt - –ø–æ–∫–∞–∑–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã
# select * from request_logs limit 5; - –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏
```

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
- **Swagger UI**: http://localhost:8000/docs
- **ReDoc**: http://localhost:8000/redoc
